<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Voice Q&amp;A Recorder</title>
<style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background-color: #f4f4f4;
    }
    .question-block {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .question-text {
      font-size: 1.1em;
      margin-bottom: 10px;
      padding: 6px;
      border: 1px dashed transparent;
    }
    .question-text[contenteditable="true"]:focus {
      border: 1px dashed #888;
      background-color: #f0f8ff;
      outline: none;
    }
    button {
      padding: 8px 16px;
      margin: 5px 5px 5px 0;
      cursor: pointer;
    }
    .answer {
      margin-top: 10px;
      padding: 10px;
      background: #e9ecef;
      border-radius: 5px;
      min-height: 30px;
    }
  </style>
</head>
<body>
<script>
// === Dynamic STORAGE_KEY from URL or fallback to default ===
function getStorageKey() {
  const params = new URLSearchParams(window.location.search);
  let id = params.get('id');
  if (!id) {
    return 'qa_data_japenese_main';
  }
  return 'qa_data_japenese' + id;
}
const STORAGE_KEY = getStorageKey();
</script>
<h1>Questions and Answers â€“ Voice Recording (Russian)</h1>
<h2>ğŸ“‚ Import questions from file:</h2>
<input accept=".docx,.txt" id="file-input" type="file"/>
<div id="questions-container">
<!-- Initial Questions -->
<div class="question-block" data-index="0">
<div class="question-text" contenteditable="true">1. éŒ²éŸ³é–‹å§‹</div>
<button onclick="speakQuestion(0)">ğŸ”ˆ Read</button>
<button onclick="startRecognition(0)">ğŸ¤ Start Recording</button>
<button onclick="stopRecognition()">ğŸ›‘ Stop</button>
<button onclick="playAudio(0)">â–¶ï¸ Play</button>
<div class="answer" id="answer-0"></div>
<textarea placeholder="âœï¸ Type your answer here..." style="width: 100%; margin-top: 10px;"></textarea>
<audio controls="" id="audio-0" style="display: none;"></audio>
</div>
<div class="question-block" data-index="1">
<div class="question-text" contenteditable="true">2. </div>
<button onclick="speakQuestion(1)">ğŸ”ˆ Read</button>
<button onclick="startRecognition(1)">ğŸ¤ Start Recording</button>
<button onclick="stopRecognition()">ğŸ›‘ Stop</button>
<button onclick="playAudio(1)">â–¶ï¸ Play</button>
<div class="answer" id="answer-1"></div>
<textarea placeholder="âœï¸ Type your answer here..." style="width: 100%; margin-top: 10px;"></textarea>
<audio controls="" id="audio-1" style="display: none;"></audio>
</div>
</div>
<button onclick="addNewQuestion()">â• â• Add New Question</button>
<button onclick="saveData()">ğŸ’¾ Save Now</button>
<button onclick="exportData()">ğŸ“¤ Export Data</button>
<script>
    let recognition;
    let currentAnswerIndex = null;
    let questionCount = 2; // Báº¯t Ä‘áº§u tá»« cÃ¢u thá»© 2

    if (!('webkitSpeechRecognition' in window)) {
      alert('Speech recognition not supported in this browser.');
    } else {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.lang = 'ja-JP';

      recognition.onresult = function(event) {
  let transcript = '';
  for (let i = event.resultIndex; i < event.results.length; ++i) {
    if (event.results[i].isFinal) {
      transcript += event.results[i][0].transcript;
    }
  }
  if (currentAnswerIndex !== null && transcript) {
    const answerBox = document.getElementById(`answer-${currentAnswerIndex}`);
    answerBox.textContent += (answerBox.textContent.trim() ? '. ' : '') + transcript;
  }
};
      recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
      };
    }

    function startRecognition(index) {
      currentAnswerIndex = index;
      if (recognition) recognition.start();
      startAudioRecording(index);
    }

    function stopRecognition() {
      if (recognition) recognition.stop();
      stopAudioRecording();
    }

    // === Audio Recording ===
    let mediaRecorder;
    let audioChunks = [];
    let currentAudioIndex = null;

    async function startAudioRecording(index) {
      currentAudioIndex = index;
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = (e) => {
        audioChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioURL = URL.createObjectURL(blob);
        const audioElement = document.getElementById(`audio-${currentAudioIndex}`);
        audioElement.src = audioURL;
        audioElement.style.display = 'block';
      };

      mediaRecorder.start();
    }

    function stopAudioRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
    }

    function playAudio(index) {
      const audio = document.getElementById(`audio-${index}`);
      audio.play();
    }

    // === Text-to-Speech (giá»ng ná»¯ náº¿u cÃ³) ===
    let femaleVoice = null;

function loadVoices() {
  const voices = speechSynthesis.getVoices();

  console.log("ğŸ“¢ Danh sÃ¡ch giá»ng kháº£ dá»¥ng:");
  voices.forEach(v => console.log(`${v.name} - ${v.lang}`));

  // Æ¯u tiÃªn giá»ng Google espaÃ±ol (es-ES)
  femaleVoice = voices.find(v =>
    v.name.includes("Google æ—¥æœ¬èª") && v.lang === "ja-JP"
  );

  // Náº¿u khÃ´ng cÃ³, chá»n giá»ng es-ES báº¥t ká»³
  if (!femaleVoice) {
    femaleVoice = voices.find(v => v.lang === "ja-JP");
  }

  // Náº¿u váº«n khÃ´ng cÃ³, dÃ¹ng báº¥t ká»³ giá»ng tiáº¿ng TÃ¢y Ban Nha nÃ o
  if (!femaleVoice) {
    femaleVoice = voices.find(v => v.lang.startsWith("ja"));
  }

  console.log("âœ… Giá»ng Ä‘Ã£ chá»n:", femaleVoice?.name || "KhÃ´ng tÃ¬m tháº¥y");
}

speechSynthesis.onvoiceschanged = loadVoices;
window.onload = () => {
  setTimeout(loadVoices, 100); // Äá»£i Ä‘á»ƒ cháº¯c cháº¯n load Ä‘Æ°á»£c danh sÃ¡ch voice
};

    speechSynthesis.onvoiceschanged = loadVoices;

    function speakQuestion(index) {
      const text = document.querySelector(`.question-block[data-index="${index}"] .question-text`).textContent;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.voice = femaleVoice;
      utterance.lang = 'ja-JP';
      utterance.volume = 1;
      speechSynthesis.speak(utterance);
    }

    // === â• Add New Question ===
    
function addNewQuestion() {
  const container = document.getElementById('questions-container');
  const index = questionCount;

  const questionDiv = document.createElement('div');
  questionDiv.className = 'question-block';
  questionDiv.setAttribute('data-index', index);

  questionDiv.innerHTML = `
    <div class="question-text" contenteditable="true">${index + 1}. </div>
    <button onclick="speakQuestion(${index})">ğŸ”ˆ Read</button>
    <button onclick="startRecognition(${index})">ğŸ¤ Start Recording</button>
    <button onclick="stopRecognition()">ğŸ›‘ Stop</button>
    <button onclick="playAudio(${index})">â–¶ï¸ Play</button>
    <div class="answer" id="answer-${index}"></div>
    <textarea placeholder="âœï¸ Type your answer here..." style="width: 100%; margin-top: 10px;"></textarea>
    <audio id="audio-${index}" controls style="display: none;"></audio>
  `;

  container.appendChild(questionDiv);
  questionCount++;

  setTimeout(saveData, 500);
}

    window.onload = loadVoices;

    
    function saveData() {
      const questions = [];
      document.querySelectorAll('.question-block').forEach(block => {
        const index = block.dataset.index;
        const questionTextEl = block.querySelector('.question-text');
        const answerTextDiv = block.querySelector(`#answer-${index}`);
        const textarea = block.querySelector('textarea');

        if (!questionTextEl) return;

        const questionText = questionTextEl.textContent || "";
        const answerText = (textarea ? textarea.value.trim() : "") || (answerTextDiv ? answerTextDiv.textContent.trim() : "");

        questions.push({ question: questionText, answer: answerText });
      });

      localStorage.setItem(STORAGE_KEY, JSON.stringify(questions));
      console.log("âœ… Dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c lÆ°u vÃ o localStorage");
    }


    function loadData() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) return;
      const data = JSON.parse(saved);

      // Äáº£m báº£o cÃ³ Ä‘á»§ sá»‘ cÃ¢u há»i Ä‘á»ƒ gÃ¡n dá»¯ liá»‡u
      while (questionCount < data.length) {
        addNewQuestion();
      }

      data.forEach((item, i) => {
        const block = document.querySelector(`.question-block[data-index="${i}"]`);
        if (!block) return;
        const qEl = block.querySelector('.question-text');
        if (qEl) qEl.textContent = item.question;
        const aEl = block.querySelector(`#answer-${i}`);
        if (aEl) aEl.textContent = item.answer;
        const textarea = block.querySelector("textarea");
        if (textarea) textarea.value = item.answer;
      });
      const savedAudios = JSON.parse(localStorage.getItem(STORAGE_KEY + "_audio") || "{}");
  Object.entries(savedAudios).forEach(([index, base64]) => {
    const audioEl = document.getElementById(`audio-${index}`);
    if (audioEl) {
      audioEl.src = base64;
      audioEl.style.display = 'block';
    }
  });
}
    

// Hook save events
    document.addEventListener("input", saveData);
    window.addEventListener("beforeunload", saveData);
    window.addEventListener("DOMContentLoaded", loadData);

  </script>
<script>
  document.addEventListener("mouseup", function () {
    const selectedText = window.getSelection().toString().trim();
    if (selectedText) {
      const prompt = `Chá»‰nh sá»­a giÃºp tÃ´i Ä‘oáº¡n vÄƒn sau, chá»‰nh sá»­a tá»«ng cÃ¢u má»™t, chá»‰ ra Ä‘iá»ƒm sai vÃ  sá»­a tháº¿ nÃ o lÃ  há»£p lÃ½, viáº¿t láº¡i cÃ¢u Ä‘Ã³ Ä‘Ãºng theo vÄƒn viáº¿t thÃ¬ tháº¿ nÃ o vÃ  vÄƒn nÃ³i nhÆ° tháº¿ nÃ o. Sau Ä‘Ã³ thÃ¬ thÃªm 2 - 3 cÃ¢u Ä‘á»“ng nghÄ©a Ä‘á»ƒ diá»…n Ä‘áº¡t Ã½ cá»§a tá»«ng cÃ¢u Ä‘Ã³:\n\n"${selectedText}"`;
      const url = `https://chat.openai.com/?q=${encodeURIComponent(prompt)}`;
      window.open(url, "_blank", "width=600,height=700");
    }
  });
</script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script>
document.getElementById("file-input").addEventListener("change", function (event) {
  const file = event.target.files[0];
  if (!file) return;

  if (file.name.endsWith(".txt")) {
    const reader = new FileReader();
    reader.onload = function () {
      importQuestions(reader.result.split(/\r?\n/).filter(Boolean));
    };
    reader.readAsText(file);
  } else if (file.name.endsWith(".docx")) {
    const reader = new FileReader();
    reader.onload = function (event) {
      mammoth.extractRawText({ arrayBuffer: event.target.result }).then(function (result) {
        const questions = result.value.split("\n").filter(Boolean);
        importQuestions(questions);
      });
    };
    reader.readAsArrayBuffer(file);
  } else {
    alert("Only .txt or .docx files are supported");
  }
});

function importQuestions(questions) {
  questions.forEach((qText, idx) => {
    const index = questionCount;
    const container = document.getElementById("questions-container");

    const questionDiv = document.createElement("div");
    questionDiv.className = "question-block";
    questionDiv.setAttribute("data-index", index);

    questionDiv.innerHTML = `
      <div class="question-text" contenteditable="true">${index + 1}. ${qText}</div>
      <button onclick="speakQuestion(${index})">ğŸ”ˆ Read</button>
      <button onclick="startRecognition(${index})">ğŸ¤ Start Recording</button>
      <button onclick="stopRecognition()">ğŸ›‘ Stop</button>
      <button onclick="playAudio(${index})">â–¶ï¸ Play</button>
      <div class="answer" id="answer-${index}"></div>
      <textarea placeholder="âœï¸ Type your answer here..." style="width: 100%; margin-top: 10px;"></textarea>
      <audio id="audio-${index}" controls style="display: none;"></audio>
    `;

    container.appendChild(questionDiv);
    questionCount++;
  });

  setTimeout(() => { saveData(); }, 1000);
}

// === Export data as JSON file ===
// === Export data as Plain Text ===
function exportData() {
  const blocks = document.querySelectorAll(".question-block");
  let exportContent = "";
  blocks.forEach((block, idx) => {
    const question = block.querySelector(".question-text").textContent.trim();
    const answerDiv = block.querySelector(".answer");
    const textarea = block.querySelector("textarea");
    const answer = (textarea?.value.trim() || answerDiv?.textContent.trim() || "").trim();
    exportContent += `${idx + 1}. ${question}\nAnswer: ${answer}\n\n`;
  });

  const blob = new Blob([exportContent], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "qa_export.txt";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

</script>
<!-- Button to create new session -->
<button onclick="createNewSession()">â• Create New Session</button>
<button onclick="saveSessionName()">ğŸ’¾ Save Session Name &amp; ğŸ“œ History</button>
<input id="session-name" placeholder="Enter session name..." style="margin-left:10px;" type="text"/>
<div id="session-history" style="margin-top: 20px; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1);">
<h3>ğŸ“š Session History</h3>
<ul id="history-list" style="list-style: none; padding-left: 0;"></ul>
</div>
<script>
function createNewSession() {
  const newId = Date.now() + '_' + Math.floor(Math.random() * 100000);
  window.open(`?id=${newId}`, '_blank');
}
</script>
<script>
// === Save session with name ===
function saveSessionName() {
  const name = document.getElementById('session-name').value.trim();
  if (!name) return alert("âš ï¸ Please enter a session name!");

  const sessionId = new URLSearchParams(location.search).get("id");
  if (!sessionId) return alert("âŒ No session ID found!");

  const sessionHistory = JSON.parse(localStorage.getItem("qa_session_history") || "[]");
  const existing = sessionHistory.find(s => s.id === sessionId);
  if (existing) {
    existing.name = name;
  } else {
    sessionHistory.push({ id: sessionId, name });
  }

  localStorage.setItem("qa_session_history", JSON.stringify(sessionHistory));
  loadSessionHistory();
}

// === Load & show session history ===
function loadSessionHistory() {
  const list = document.getElementById("history-list");
  if (!list) return;
  list.innerHTML = "";
  const sessions = JSON.parse(localStorage.getItem("qa_session_history") || "[]");

  sessions.forEach(({ id, name }, index) => {
    const li = document.createElement("li");
    li.innerHTML = `
  <strong>#${index + 1}</strong> 
  <input type="text" value="${name}" onchange="renameSession('${id}', this.value)" style="width: 200px;" />
  <button onclick="window.open('?id=${id}', '_blank')">ğŸ” Open</button>
  <button onclick="deleteSession('${id}')">âŒ Delete</button>
`;
    list.appendChild(li);
  });
}

function renameSession(id, newName) {
  const sessions = JSON.parse(localStorage.getItem("qa_session_history") || "[]");
  const session = sessions.find(s => s.id === id);
  if (session) {
    session.name = newName;
    localStorage.setItem("qa_session_history", JSON.stringify(sessions));
  }
}

function deleteSession(id) {
  let sessions = JSON.parse(localStorage.getItem("qa_session_history") || "[]");
  sessions = sessions.filter(s => s.id !== id);
  localStorage.setItem("qa_session_history", JSON.stringify(sessions));
  loadSessionHistory();
}

// === Auto load on start ===
window.addEventListener("DOMContentLoaded", loadSessionHistory);
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script><script>
// === Enhanced Audio Save & Export ===
function saveAudioBase64(index, blob) {
  const reader = new FileReader();
  reader.onloadend = () => {
    const base64Audio = reader.result;
    const savedAudios = JSON.parse(localStorage.getItem(STORAGE_KEY + "_audio") || "{}");
    savedAudios[index] = base64Audio;
    localStorage.setItem(STORAGE_KEY + "_audio", JSON.stringify(savedAudios));

    const audioElement = document.getElementById(`audio-${index}`);
    audioElement.src = base64Audio;
    audioElement.style.display = 'block';
  };
  reader.readAsDataURL(blob);
}

mediaRecorder.onstop = () => {
  const blob = new Blob(audioChunks, { type: 'audio/webm' });
  saveAudioBase64(currentAudioIndex, blob);
};



// Export Q&A with Audio files as .zip
function exportData() {
  const zip = new JSZip();
  const blocks = document.querySelectorAll(".question-block");
  let exportContent = "";
  const savedAudios = JSON.parse(localStorage.getItem(STORAGE_KEY + "_audio") || "{}");

  blocks.forEach((block, idx) => {
    const question = block.querySelector(".question-text").textContent.trim();
    const textarea = block.querySelector("textarea");
    const answer = textarea?.value.trim() || "";

    exportContent += `${idx + 1}. ${question}\nAnswer: ${answer}\n\n`;

    const base64Audio = savedAudios[idx];
    if (base64Audio) {
      const base64 = base64Audio.split(",")[1];
      zip.file(`audio_${idx + 1}.webm`, base64, { base64: true });
    }
  });

  zip.file("qa_export.txt", exportContent);

  zip.generateAsync({ type: "blob" }).then(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "qa_export.zip";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });
}
</script></body>
</html>
